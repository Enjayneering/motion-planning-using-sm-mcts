import numpy as np
from scipy import interpolate
from scipy.spatial import KDTree

# import modules
import os 
import sys
cwd = os.getcwd()
parent_dir = os.path.dirname(cwd)
sys.path.insert(0, parent_dir)

#TODO: DONE

def get_closest_gridpoint(point=None, list_of_points=None):
    # takes a list of points (e.g. from centerline) and a point (e.g. from state) and returns the closest point from the list
    init_pos = np.array([point[0], point[1]])
    next_pos = np.array(list_of_points)

    # Calculate the Euclidean distance from the initial position to each next position
    distances = np.linalg.norm(next_pos - init_pos, axis=1)

    # Find the index of the next position with the smallest distance
    closest_index = np.argmin(distances)

    # Get the closest next position
    closest_x_next, closest_y_next = next_pos[closest_index]
    return closest_x_next, closest_y_next

def get_interpolated_centerline_KD_tree(point_list, metric_dist=0.5, k=1):
    centerline = {}

    # Combine the x and y coordinates into an array of 2D points
    points = np.array(point_list)

    # Calculate the cumulative distance along the path
    distance = np.cumsum(np.sqrt(np.sum(np.diff(points, axis=0)**2, axis=1)))
    distance = np.insert(distance, 0, 0)

    # Create a spline representation of the path
    tck, u = interpolate.splprep(points.T, u=distance, s=0, k=k)

    # Interpolate the points along the path at metric_dist intervals
    new_distance = np.arange(0, distance.max(), metric_dist)
    progress_values = np.array(new_distance)

    new_points = interpolate.splev(new_distance, tck)
    # Convert the interpolated points to a list of tuples
    interpolated_points = list(zip(*new_points))
    # Build the KD-tree from the coordinates
    coordinates = np.array(interpolated_points)
    centerline_tree = KDTree(coordinates)

    centerline['KDtree'] = centerline_tree
    centerline['s_coord'] = progress_values
    return centerline

occupancy_grid_dict = {
            'racetrack_1': """
            ################
            #..............#
            #..............#
            #01............#
            #..............#
            #..............#
            ################""",
            'racetrack_moving_barrier_1':"""
            ################
            #..............#
            #.1............#
            #0.............#
            #..............#
            #..............#
            ################""",
            'racetrack_moving_barrier_2':"""
            ################
            #..............#
            #.1............#
            #0.............#
            #..............#
            #..............#
            ################""",
            'intersection_1': """
            ################
            #####......#####
            #####......#####
            #####......#####
            #####......#####
            #..............#
            #..............#
            #..............#
            #..............#
            #..............#
            #..............#
            #####......#####
            #####......#####
            #####......#####
            #####......#####
            ################""",
            'trichter_1': """
            ################
            #........#######
            #..........#####
            #0.1...........#
            #..........#####
            #........#######
            ################""",
            'door_1_open': """
            #############
            #....########
            #...........#
            #....########
            #############""",
            'door_1_closed': """
            #############
            #....########
            #....#......#
            #....########
            #############""",
            'benchmark_static_dragrace': """
            #######
            #.....#
            #.....#
            #.....#
            #.....#
            #.....#
            #######""",
            'benchmark_dynamic_small1': """
            #########
            #...#...#
            #01.....#
            #...#...#
            #.......#
            #...#...#
            #########""",
            'benchmark_dynamic_small1_1': """
            #########
            #...#...#
            #...#...#
            #...#...#
            #.......#
            #...#...#
            #########""",
            'benchmark_dynamic_small2': """
            ############
            #....##....#
            #...0......#
            #....##....#
            #.1........#
            #....##....#
            ############""",
            'benchmark_dynamic_small2_1': """
            ############
            #....##....#
            #....#.....#
            #....##....#
            #..........#
            #....##....#
            ############""",
            'benchmark_dynamic_small2_2': """
            ############
            #....##....#
            #....#.....#
            #....##....#
            #.....#....#
            #....##....#
            ############""",
            'door_2_open': """
            ###############
            #......########
            #......########
            #.............#
            #......########
            #......########
            ###############""",
            'door_2_closed': """
            ###############
            #......########
            #......########
            #......#......#
            #......########
            #......########
            ###############""",
            'occupancy_grid_maze': """
            ####################
            #...........#......#
            #.....#######......#
            #...........#......#
            #...........#......#
            #.....#............#
            #.....#............#
            #.....#######......#
            #...........#......#
            ####################""",
            'occupancy_grid_free': """
            ....................
            ....................
            ....................
            ....................
            ....................
            ....................
            ....................""",
            'occupancy_grid_10': """
            .......#............
            ....................
            .......#............
            .......#............
            .......#............
            .......#............
            .......#............""",

            'occupancy_grid_11': """
            .......#............
            ....................
            ....................
            .......#............
            .......#............
            .......#............
            .......#............""",

            'occupancy_grid_12': """
            ...#............
            ................
            ...#............
            ...#............
            ...#............
            ...#............
            ...#............""",

            'occupancy_grid_20': """
            .......#............
            ....................
            .......#............
            .......#............
            .......#............
            ....................
            .......#............""",

            'occupancy_grid_21_open': """
            .......#............
            ....................
            .......#............
            .01.................
            .......#............
            ....................
            .......#............""",
            'occupancy_grid_21_closed': """
            .......#............
            .......#............
            .......#............
            ....................
            .......#............
            .......#............
            .......#............""",
            'occupancy_grid_big_open': """
            ##################################################
            #................##..............................#
            #.................##.............................#
            #..................##............................#
            #...................##...........................#
            #....................#...........................#
            #................................................#
            #................................................#
            #....................#...........................#
            #....................#...........................#
            #....................##..........................#
            #.....................##.........................#
            #......................##........................#
            #.......................#........................#
            #.......................#........................#
            #................................................#
            #................................................#
            #.......................#........................#
            #.......................#........................#
            #.......................#........................#
            #.......................#........................#
            ##################################################""",
            'occupancy_grid_big_closed': """
            ##################################################
            #................##..............................#
            #.................##.............................#
            #..................##............................#
            #...................##...........................#
            #....................#...........................#
            #................................................#
            #................................................#
            #....................#...........................#
            #....................#...........................#
            #....................##..........................#
            #.....................##.........................#
            #......................##........................#
            #.......................#........................#
            #.......................#........................#
            #.......................#........................#
            #.......................#........................#
            #.......................#........................#
            #.......................#........................#
            #.......................#........................#
            #.......................#........................#
            ##################################################""",
            'occupancy_grid_30': """
            ####################
            ..################..
            ....############....
            ....................
            ....############....
            ..################..
            ####################""",
            'occupancy_grid_31': """
            ####################
            .##################.
            .##################.
            ....................
            .##################.
            .##################.
            ####################""",
            'occupancy_grid_40': """
            ....#..
            ...##..
            .......
            ...##..
            ....#..""",
            'occupancy_grid_41': """
            ......#..
            .....##..
            .........
            .........
            .....##..
            ......#..""",

        }